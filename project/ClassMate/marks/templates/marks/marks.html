{% extends "base.html" %}
{% load static %}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'marks/marks.css' %}">
{% endblock %}

{% block content %}
<div class="marks-navbar">
    {% for section in sections %}
    <a href="{% url 'show_marks' section.id %}" 
       class="{% if current_section and section.id == current_section.id %}active{% endif %}">
        {{ section.course.course_code }}
    </a>
    {% endfor %}
</div>

{% block section_content %}
<div class="marks-container">
    {% if current_section %}
    <h2 class="course-title">{{ current_section.course.course_code }} {{ current_section.course.course_name }}</h2>

    <div class="marks-details">
        {% for heading_data in marks_data %}
        <div class="heading-container">
            <h3 class="heading-title" onclick="toggleSubcategories(this)">
                <span class="heading-text">{{ heading_data.heading.name }}</span>
                <span class="toggle-icon">&#9660;</span>
            </h3>
            <div class="subcategory-list">
                <table class="marks-table">
                    <thead>
                        <tr>
                            <th>Subcategory</th>
                            <th>Obtained</th>
                            <th>Total</th>
                            <th>Min</th>
                            <th>Max</th>
                            <th>Avg</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for subcategory_data in heading_data.subcategories %}
                        <tr>
                            <td>{{ subcategory_data.subcategory.name }}</td>
                            <td>{{ subcategory_data.student_marks }}</td>
                            <td>{{ subcategory_data.subcategory.total_marks }}</td>
                            <td>{{ subcategory_data.min_marks }}</td>
                            <td>{{ subcategory_data.max_marks }}</td>
                            <td>{{ subcategory_data.avg_marks }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% endfor %}

        <!-- {% if analysis_data %}
        <div class="analysis-section">
            <h3>Course Analysis</h3>
            <p>Total Weightage Accumulated: {{ analysis_data.total_weightage }}%</p>
            <p>Your Weighted Marks: {{ analysis_data.obtained_weightage }}%</p>
            <p>Your Percentile: {{ analysis_data.user_percentile }}%</p>
            <p>Class Average Weighted Marks: {{ analysis_data.class_avg }}%</p>
            <canvas id="bellCurve" width="800" height="400"></canvas>
        </div>
        {% endif %} -->
    </div>
    {% else %}
    <p class="no-sections">No sections available.</p>
    {% endif %}
</div>

<script>
function toggleSubcategories(element) {
    const subcategoryList = element.nextElementSibling;
    const toggleIcon = element.querySelector('.toggle-icon');
    const isVisible = subcategoryList.classList.contains('active');
    
    subcategoryList.classList.toggle('active');
    toggleIcon.innerHTML = isVisible ? '&#9660;' : '&#9650;';
    
    const allSubcategoryLists = document.querySelectorAll('.subcategory-list');
    allSubcategoryLists.forEach(list => {
        if (list !== subcategoryList) {
            list.classList.remove('active');
            list.previousElementSibling.querySelector('.toggle-icon').innerHTML = '&#9660;';
        }
    });
}

document.addEventListener("DOMContentLoaded", function () {
    const canvas = document.getElementById('bellCurve');
    const analysisData = JSON.parse(document.getElementById('analysis-data').textContent);
    
    if (canvas && analysisData) {
        const ctx = canvas.getContext('2d');
        const userPercentile = analysisData.user_percentile;
        
        function drawBellCurve(ctx, userPercentile) {
            const width = canvas.width;
            const height = canvas.height;
            ctx.clearRect(0, 0, width, height);

            ctx.beginPath();
            ctx.moveTo(0, height);
            for (let x = 0; x < width; x++) {
                const y = height - (height / 1.5) * Math.exp(-Math.pow((x - width / 2) / (width / 6), 2));
                ctx.lineTo(x, y);
            }
            ctx.lineTo(width, height);
            ctx.closePath();
            ctx.fillStyle = '#e0f7fa';
            ctx.fill();

            const userX = width * (userPercentile / 100);
            ctx.fillStyle = '#007bff';
            ctx.fillRect(userX - 2, height - 10, 4, 10);
        }

        drawBellCurve(ctx, userPercentile);
    }
});
</script>
{% endblock %}
{% endblock %}
